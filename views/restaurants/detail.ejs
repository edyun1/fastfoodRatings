<%- include("../partials/header") %>

<div class="panel" style="display:flex; gap:12px; align-items:center;">
  <img class="logo" src="https://img.logo.dev/<%= restaurant.domain %>?token=<%= logoToken %>" alt="<%= restaurant.chain %> logo">
  <div>
    <div class="title" style="font-size:20px;"><%= restaurant.chain %></div>
    <div class="sub"><%= restaurant.locationName %></div>
    <div class="tiny"><%= restaurant.city %>, <%= restaurant.state %></div>
  </div>
</div>

<div class="panel">
  <div class="sub">
    Average rating:
    <strong><%= avg === null ? "No ratings yet" : avg.toFixed(2) %></strong>
    <span class="tiny">(<%= count %> total)</span>
  </div>
  <div style="margin-top:10px;">
    <a class="btn" href="/restaurants/<%= restaurant._id %>/ratings/new">Rate this location</a>
  </div>
</div>

<div id="weather" class="panel">Loading weather...</div>

<h3>Recent ratings</h3>

<% if (ratings.length === 0) { %>
  <div class="panel">No ratings yet.</div>
<% } %>

<% ratings.forEach(rt => { %>
  <div class="panel">
    <div class="title"><%= rt.rating %>/5</div>
    <div class="tiny"><%= new Date(rt.createdAt).toLocaleString() %></div>
  </div>
<% }) %>

<script>
  fetch(`/api/weather?city=${encodeURIComponent("<%= restaurant.city %>")}&state=${encodeURIComponent("<%= restaurant.state %>")}`)
    .then(r => r.json())
    .then(data => {
      const el = document.getElementById("weather");
      if (!data || data.error || !data.current) {
        el.textContent = "Weather unavailable.";
        return;
      }
      const c = data.current;
      el.innerHTML = `
        <div class="title">Current Weather</div>
        <div class="sub">Temp: ${c.temperature_2m}Â°C</div>
        <div class="sub">Wind: ${c.wind_speed_10m} km/h</div>
      `;
    })
    .catch(() => {
      document.getElementById("weather").textContent = "Weather unavailable.";
    });
</script>

<%- include("../partials/footer") %>
